#!/usr/bin/env bash

set -eo pipefail

indent() {
  sed -u 's/^/       /'
}

# Configure directories
build_dir=$1
cache_dir=$2
env_dir=$3

echo "-----> Setting PATH for nodejs"
PATH="$build_dir/vendor/node/bin:$build_dir/bin:$build_dir/node_modules/.bin:$PATH"

echo "-----> Found an Ember CLI app"

if ! (which ember > /dev/null)
then
  echo "-----> Installing ember-cli..."
  npm install --userconfig $build_dir/.npmrc ember-cli 2>&1 | indent
  echo "...done" | indent
fi

# If app has a node_modules directory, cache it.
if test -d $build_dir/node_modules; then
  echo "-----> Caching node_modules directory for future builds"
  cp -r $build_dir/node_modules $cache_dir/node
fi

cd $build_dir
pwd | indent

echo "-----> Building ember-cli app..."
ember build --environment production | indent
echo "...done" | indent

ls -l

echo "-----> Ember app build to dist/ directory"
